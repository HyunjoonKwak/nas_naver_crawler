# 🔔 알림 시스템 사용 가이드

## 📋 목차
1. [개요](#개요)
2. [Discord 웹훅 설정](#discord-웹훅-설정)
3. [알림 생성하기](#알림-생성하기)
4. [알림 테스트](#알림-테스트)
5. [알림 작동 방식](#알림-작동-방식)
6. [문제 해결](#문제-해결)

---

## 개요

이 알림 시스템은 크롤링 완료 후 **신규 매물**, **삭제된 매물**, **가격 변동**을 자동으로 감지하여 Discord로 알림을 보냅니다.

### 주요 기능
- ✅ 신규 매물 감지 및 알림
- ✅ 삭제된 매물 감지 (거래 완료 가능성)
- ✅ 가격 변동 감지 및 알림
- ✅ 조건별 필터링 (거래유형, 가격대, 면적)
- ✅ Discord Rich Embed 포맷
- ✅ 알림 로그 저장

---

## Discord 웹훅 설정

### 1단계: Discord 채널에서 웹훅 생성

1. Discord 서버에서 알림을 받을 채널로 이동
2. 채널 설정 (톱니바퀴 아이콘) 클릭
3. **연동** → **웹후크** 선택
4. **새 웹후크** 버튼 클릭
5. 웹후크 이름 설정 (예: "부동산 크롤러")
6. **웹후크 URL 복사** 버튼 클릭

### 2단계: 웹훅 URL 형식 확인

```
https://discord.com/api/webhooks/123456789/abcdefghijklmnop
```

이 URL을 알림 설정 시 사용합니다.

---

## 알림 생성하기

### 웹 UI에서 생성

1. 홈페이지에서 **🔔 알림** 버튼 클릭
2. **➕ 새 알림 만들기** 버튼 클릭
3. 알림 정보 입력:

#### 필수 항목
- **알림 이름**: 알림을 구분할 이름 (예: "강남 전세 알림")
- **관심 단지**: 모니터링할 단지 선택 (복수 선택 가능)
- **Discord 웹훅 URL**: 위에서 복사한 URL

#### 선택 항목
- **거래 유형**: 매매, 전세, 월세 (선택 안하면 전체)
- **가격 범위**: 최소/최대 가격 (만원 단위)
  - 예: 10000 (1억) ~ 50000 (5억)
- **면적 범위**: 최소/최대 면적 (㎡)
  - 예: 60㎡ ~ 100㎡

### 예시 1: 강남 전세 알림
```
이름: 강남 전세 알림
단지: [헬리오시티] [래미안] [아크로리버파크]
거래유형: 전세
가격: 30000만 ~ 80000만
면적: 80㎡ ~ 120㎡
```

### 예시 2: 분당 매매 알림
```
이름: 분당 매매 저가 알림
단지: [판교원마을 푸르지오]
거래유형: 매매
가격: ~ 100000만 (1억~10억)
면적: 제한없음
```

---

## 알림 테스트

### 방법 1: UI에서 테스트
1. 알림 생성/수정 화면에서
2. 웹훅 URL 입력 후
3. **🧪 테스트 알림 보내기** 버튼 클릭
4. Discord 채널에서 테스트 메시지 확인

### 방법 2: API로 테스트
```bash
curl -X POST http://localhost:3000/api/alerts/test \
  -H "Content-Type: application/json" \
  -d '{
    "webhookUrl": "YOUR_DISCORD_WEBHOOK_URL",
    "testType": "summary"
  }'
```

테스트 타입:
- `new`: 신규 매물 알림
- `deleted`: 삭제된 매물 알림
- `priceChanged`: 가격 변동 알림
- `summary`: 크롤링 완료 요약

---

## 알림 작동 방식

### 1. 크롤링 실행 시

```
사용자가 크롤링 시작
    ↓
크롤러가 네이버 부동산 수집
    ↓
수집된 데이터를 DB에 저장
    ↓
이전 크롤링 결과와 비교
    ↓
변경사항 감지 (신규/삭제/가격변동)
    ↓
활성화된 알림 조회
    ↓
알림 조건 필터링
    ↓
Discord 웹훅으로 전송
```

### 2. 변경사항 감지 로직

#### 신규 매물
- 이전 크롤링에 없던 `articleNo`
- 초록색 임베드로 표시

#### 삭제된 매물
- 이전에 있었지만 현재 없는 `articleNo`
- 빨간색 임베드로 표시
- 거래 완료 가능성 높음

#### 가격 변동
- 동일 `articleNo`의 가격 변화
- 가격 하락: 초록색
- 가격 상승: 주황색

### 3. Discord 알림 형식

#### 신규 매물 알림
```
🆕 신규 매물 발견!
━━━━━━━━━━━━━━━━
🏘️ 단지: 헬리오시티
📊 거래유형: 전세
💰 가격: 5억
📐 면적: 84.5㎡ (25.5평)
🏢 동/호: 101동 1001호
📍 층: 10/20
🧭 방향: 남향
🏢 중개소: ABC 부동산
```

#### 크롤링 완료 요약
```
✅ 크롤링 완료 - 변경사항 있음
━━━━━━━━━━━━━━━━
🏘️ 단지: 헬리오시티
🆕 신규 매물: 3건
🗑️ 삭제된 매물: 2건
💹 가격 변동: 1건
📊 전체 매물: 25건
⏱️ 소요 시간: 5.4초
```

---

## 알림 관리

### 알림 활성화/비활성화
- 알림 카드에서 **✓ 활성** 버튼 클릭으로 토글
- 비활성화된 알림은 작동하지 않음

### 알림 수정
- 알림 카드에서 **✏️ 수정** 버튼 클릭
- 조건 변경 후 저장

### 알림 삭제
- 알림 카드에서 **🗑️ 삭제** 버튼 클릭
- 확인 후 삭제 (복구 불가)

### 알림 로그 확인
- 각 알림 카드에서 최근 알림 기록 확인
- 전송 성공/실패 여부 표시

---

## 문제 해결

### 알림이 오지 않아요
1. **알림이 활성화되어 있나요?**
   - 알림 카드에서 **✓ 활성** 상태 확인

2. **웹훅 URL이 올바른가요?**
   - Discord에서 웹훅 URL 재확인
   - 테스트 알림으로 확인

3. **조건이 너무 까다롭지 않나요?**
   - 가격/면적 조건을 넓게 설정해보세요
   - 거래유형을 "전체"로 설정해보세요

4. **실제로 변경사항이 있나요?**
   - 크롤링을 2번 이상 실행해야 변경사항 감지
   - 첫 크롤링에서는 알림이 오지 않음

### 웹훅 URL이 작동하지 않아요
1. **URL 형식 확인**
   ```
   올바른 형식:
   https://discord.com/api/webhooks/123456789/abcdefghijklmnop

   잘못된 형식:
   https://discordapp.com/... (오래된 도메인)
   ```

2. **웹훅이 삭제되지 않았나요?**
   - Discord에서 웹훅 목록 확인
   - 삭제되었다면 새로 생성

3. **권한 문제**
   - 봇이 채널에 메시지를 보낼 권한이 있는지 확인

### 알림이 너무 많이 와요
1. **조건을 좁히세요**
   - 가격/면적 범위를 구체적으로 설정
   - 특정 거래유형만 선택

2. **관심 단지를 줄이세요**
   - 너무 많은 단지를 선택하면 알림이 많아짐

3. **알림을 분리하세요**
   - 단지별로 알림을 따로 만들기
   - 조건별로 알림을 분리

### Discord에서 임베드가 안 보여요
1. **임베드 권한 확인**
   - Discord 설정 → 텍스트 및 이미지 → 링크 미리보기
   - "링크에서 웹 사이트 미리보기 표시" 활성화

2. **모바일에서는?**
   - Discord 모바일 앱에서도 임베드 확인 가능
   - 앱 설정에서 미디어 자동 재생 확인

---

## API 사용 (고급)

### 알림 목록 조회
```bash
curl http://localhost:3000/api/alerts
```

### 알림 생성
```bash
curl -X POST http://localhost:3000/api/alerts \
  -H "Content-Type: application/json" \
  -d '{
    "name": "테스트 알림",
    "complexIds": ["22065"],
    "tradeTypes": ["전세"],
    "minPrice": 30000,
    "maxPrice": 80000,
    "webhookUrl": "YOUR_WEBHOOK_URL"
  }'
```

### 알림 수정
```bash
curl -X PUT http://localhost:3000/api/alerts/ALERT_ID \
  -H "Content-Type: application/json" \
  -d '{
    "name": "수정된 알림",
    ...
  }'
```

### 알림 활성화/비활성화
```bash
curl -X PATCH http://localhost:3000/api/alerts/ALERT_ID \
  -H "Content-Type: application/json" \
  -d '{"isActive": false}'
```

### 알림 삭제
```bash
curl -X DELETE "http://localhost:3000/api/alerts?id=ALERT_ID"
```

---

## 팁 & 트릭

### 1. 여러 Discord 채널에 알림 보내기
- 각 채널별로 웹훅을 생성
- 알림을 여러 개 만들어 다른 웹훅 URL 사용

### 2. 중요한 매물만 알림 받기
```
전세 저가 알림:
- 거래유형: 전세만
- 가격: ~ 40000만
- 면적: 80㎡ 이상
```

### 3. 스케줄 크롤링과 함께 사용
- 매일 자동 크롤링 + 알림으로 완전 자동화
- 다음 단계에서 스케줄 크롤링 구현 예정

### 4. 가격 하락 알림
- 가격 변동 알림이 오면 Discord에서 확인
- 초록색 임베드 = 가격 하락
- 빠르게 연락하여 계약 진행

---

## 다음 단계

Phase 1 완료! 🎉

다음으로 구현할 기능:
- ⏰ **스케줄 크롤링**: 매일 자동으로 크롤링 실행
- 📊 **가격 추이 그래프**: 시간대별 가격 변화 시각화
- 🔍 **전체 단지 검색**: 복합 조건 검색 페이지

---

**문의사항이나 버그 제보는 GitHub Issues로 부탁드립니다!**
